# ---------- DEPS ----------
    FROM node:20-alpine AS deps
    WORKDIR /app
    
    COPY package*.json ./

    # prevent postinstall (prisma generate) from running before schema exists
    RUN npm ci --ignore-scripts
    
    # ---------- BUILD ----------
    FROM node:20-alpine AS builder
    WORKDIR /app
    
    COPY --from=deps /app/node_modules ./node_modules
    COPY . .
    
    # Provide DATABASE_URL ONLY for build step
    ARG DATABASE_URL
    RUN npx prisma generate
    RUN DATABASE_URL="$DATABASE_URL" npm run build
    
    # ---------- RUNTIME ----------
    FROM node:20-alpine AS runner
    WORKDIR /app
    
    ENV NODE_ENV=production
    # Azure injects PORT at runtime; default to 8080 for local/container
    ENV PORT=8080
    
    # Copy standalone output from builder
    COPY --from=builder /app/.next/standalone ./
    COPY --from=builder /app/.next/static ./.next/static
    COPY --from=builder /app/public ./public
    COPY --from=builder /app/prisma ./prisma
    
    EXPOSE 8080
    
    # Run Next.js production server on the PORT Azure provides
    CMD ["sh", "-c", "node server.js -p ${PORT}"]